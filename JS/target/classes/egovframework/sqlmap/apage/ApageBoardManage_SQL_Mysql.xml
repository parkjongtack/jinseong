<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ApageBoardManage">
	<typeAlias  alias="apageBoardManageVo" type="egovframework.apage.board.service.apageBoardManageVo"/>
	
	<sql id="adminBoardBase">
		SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
		FROM (
			SELECT
					NTT_ID
					,BBS_ID
					,NTT_SJ
					,NTT_CN
					,ANSWER_AT
					,PARNTSCTT_NO
					,SORT_ORDR
					,RDCNT
					,USE_AT
					,DATE_FORMAT(NTCE_BGNDE, '%Y-%m-%d') AS NTCE_BGNDE
					,DATE_FORMAT(NTCE_ENDDE, '%Y-%m-%d') AS NTCE_ENDDE
					,NTCR_ID
					,NTCR_NM
					,NTUP_ID
					,NTUP_NM
					,PASSWORD
					,ATCH_FILE_ID
					,DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
					,DATE_FORMAT(UPDT_DT, '%Y-%m-%d') AS UPDT_DT
					,CHECK_YN
					,ATCH_FILE_ID2
					,MEMO
					,OPEN_YN
					,AS_TYPE
					,AS_TEL
					,AS_EMAIL
					,AS_STATUS
				FROM COMTBOARD
				WHERE BBS_ID = #bbs_id#
				<isNotEmpty property="srch_input">
					AND ntt_sj like concat('%',#srch_input#,'%')
				</isNotEmpty>
				<isNotEmpty property="scType">
					AND as_type = #scType#
				</isNotEmpty>
			 )X,(SELECT @ROWNUM := 0) R			 
	</sql>
	
	<sql id="adminStaffBase">
		SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
		FROM (
			SELECT
			 seq, staff_name, asso_type, staff_type, team,
             pro_no, career, use_hand, point_rank, hit,
             staff_info, reg_dt, reg_id, atch_file_id,atch_file_id2					
			FROM staff_manage
			<isNotEmpty property="srch_input">
			where staff_name like concat('%',#srch_input#,'%')
			</isNotEmpty>
		)X,(SELECT @ROWNUM := 0) R			 
	</sql>
	
	<!-- 게시판 리스트 -->
	<select id="selectadminBoardList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
				 	 <include refid="adminBoardBase"/>
				 	 WHERE 1 = 1
					ORDER BY ntt_id DESC
				  ) Y
		     ) Z
		WHERE ASCNUM BETWEEN #currRow# AND #endRow#
	</select>
	
	<!-- 게시판 리스트 카운트 -->
	<select id="selectadminBoardListCnt" parameterClass="ApageBoardManageVo" resultClass="int" >
		SELECT
			    COUNT(*) CNT
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
 				<include refid="adminBoardBase"/>
 				WHERE 1 = 1
			) Y
		 ) Z
	</select>
	
	<!-- 게시판 인서트 -->
	<insert id="insertAdminBoard" parameterClass="ApageBoardManageVo" >
		 INSERT INTO COMTBOARD
         	(
					 BBS_ID
					,NTT_SJ
					,NTT_CN
					,ANSWER_AT
					,PARNTSCTT_NO
					,SORT_ORDR
					,USE_AT
					,NTCE_BGNDE
					,NTCE_ENDDE
					,NTCR_ID
					,NTCR_NM
					,PASSWORD
					,ATCH_FILE_ID
					,REG_DT
					,CHECK_YN
					,ATCH_FILE_ID2
					,MEMO
					,AS_TYPE
					,AS_TEL
					,AS_EMAIL
					,AS_STATUS
					,CT_SEQ
             )
         VALUES
	         (
					#bbs_id#
					,#ntt_sj#
					,#ntt_cn#
					,#answer_at#
					,#parntsctt_no#
					,#sort_ordr#
					,#use_at#
					,#ntce_bgnde#
					,#ntce_endde#
					,#ntcr_id#
					,#ntcr_nm#
					,#password#
					,#atch_file_id#
					,NOW()
					,#check_yn#
					,#atch_file_id2#
					,#memo#
					,#as_type#
					,#as_tel#
					,#as_email#
					,#as_status#
					,#ct_seq#
	         )
	    <selectKey keyProperty="ntt_id" resultClass="int">
      	  	SELECT LAST_INSERT_ID()
   		</selectKey>
	</insert>
	
	<!-- 게시판 상세 -->
	<select id="getAdminBoardView" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >

	SELECT Q.*
			,(SELECT CT_RESULT FROM CONTEST_MANAGE WHERE CT_SEQ = Q.CT_SEQ) AS CT_RESULT
			,(SELECT LANE_SMS_SEND_YN FROM CONTEST_MANAGE WHERE CT_SEQ = Q.CT_SEQ) AS LANE_SMS_SEND_YN
	FROM ( 
		SELECT
					 NTT_ID
					,BBS_ID
					,NTT_SJ
					,NTT_CN
					,ANSWER_AT
					,PARNTSCTT_NO
					,SORT_ORDR
					,RDCNT
					,USE_AT
					,DATE_FORMAT(NTCE_BGNDE, '%Y-%m-%d') AS NTCE_BGNDE
					,DATE_FORMAT(NTCE_ENDDE, '%Y-%m-%d') AS NTCE_ENDDE
					,NTCR_ID
					,NTCR_NM
					,NTUP_ID
					,NTUP_NM
					,PASSWORD
					,ATCH_FILE_ID
					,DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
					,DATE_FORMAT(UPDT_DT, '%Y-%m-%d') AS UPDT_DT
					,CHECK_YN
					,ATCH_FILE_ID2
					,MEMO
					,OPEN_YN
					,AS_TYPE
					,AS_TEL
					,AS_EMAIL
					,AS_STATUS
					,IFNULL(CT_SEQ,0) AS CT_SEQ
					,TEMP1
					,TEMP2
					,TEMP3
					,TEMP4
		 FROM COMTBOARD
		WHERE NTT_ID = #ntt_id#
	)Q
	</select>
	
	<!-- 조회수 증가 -->
	<update id="UpdateCnt" parameterClass="ApageBoardManageVo" >
		UPDATE	COMTBOARD 
		SET		RDCNT = IFNULL(RDCNT,0) + 1
		WHERE	NTT_ID = #ntt_id#
	</update>
	
	<!-- 게시판 삭제 -->
	<delete id="adminBoardDelete" parameterClass="ApageBoardManageVo">
		DELETE 	FROM COMTBOARD
		WHERE	NTT_ID = #ntt_id#
	</delete>
	
	<!-- 게시판 수정  -->
	<update id="updateAdminBoard" parameterClass="ApageBoardManageVo">
		UPDATE COMTBOARD
		SET  
			 UPDT_DT			=		NOW()
			 <isNotEmpty property="ntt_sj">
			,NTT_SJ				=		#ntt_sj#
			</isNotEmpty>
			 <isNotEmpty property="ntt_cn">
			,NTT_CN				=		#ntt_cn#
			</isNotEmpty>
			<isNotEmpty property="answer_at">
			,ANSWER_AT			=		#answer_at#
			</isNotEmpty>
			<isNotEmpty property="use_at">
			,USE_AT				=		#use_at#
			</isNotEmpty>
			<isNotEmpty property="ntce_bgnde">
			,NTCE_BGNDE			=		#ntce_bgnde#
			</isNotEmpty>
			<isNotEmpty property="ntce_endde">
			,NTCE_ENDDE			=		#ntce_endde#
			</isNotEmpty>
			<isNotEmpty property="ntup_id">
			,NTUP_ID			=		#ntup_id#
			</isNotEmpty>
			<isNotEmpty property="ntup_nm">
			,NTUP_NM			=		#ntup_nm#
			</isNotEmpty>
			<isNotEmpty property="password">
			,PASSWORD			=		#password#
			</isNotEmpty>
			<isNotEmpty property="atch_file_id">
			,ATCH_FILE_ID		=		#atch_file_id#
			</isNotEmpty>
			<isNotEmpty property="check_yn">
			,CHECK_YN			=		#check_yn#
			</isNotEmpty>
			<isNotEmpty property="atch_file_id2">
			,ATCH_FILE_ID2		=		#atch_file_id2#
			</isNotEmpty>
			<isNotEmpty property="memo">
			,MEMO				=		#memo#
			</isNotEmpty>
			<isNotEmpty property="open_yn">
			,OPEN_YN			=		#open_yn#
			</isNotEmpty>
			<isNotEmpty property="as_type">
			,AS_TYPE			=		#as_type#
			</isNotEmpty>
			<isNotEmpty property="as_tel">
			,AS_TEL			=		#as_tel#
			</isNotEmpty>
			<isNotEmpty property="as_email">
			,AS_EMAIL			=		#as_email#
			</isNotEmpty>
			<isNotEmpty property="as_status">
			,AS_STATUS			=		#as_status#
			</isNotEmpty>
			<isNotEmpty property="temp1">
			,TEMP1			=		#temp1#
			</isNotEmpty>
			<isNotEmpty property="temp2">
			,TEMP2			=		#temp2#
			</isNotEmpty>
			<isNotEmpty property="temp3">
			,TEMP3			=		#temp3#
			</isNotEmpty>
			<isNotEmpty property="temp4">
			,TEMP4			=		#temp4#
			</isNotEmpty>
		WHERE NTT_ID = #ntt_id#
	</update>
	
	<!-- 파일 삭제시 banner테이블의 첨부파일 seq값 제거  -->
	<update id="setBoardAttachUpdt" parameterClass="ApageBoardManageVo">
		<!-- 
		UPDATE COMTBOARD
		SET  ATCH_FILE_ID = null
		WHERE NTT_ID = #ntt_id#
		 -->
		UPDATE COMTBANNER
		SET  ATCH_FILE_ID = ''
		WHERE ATCH_FILE_ID = #atch_file_id#
	</update>
	
	<!-- 파일 삭제시 board테이블의 첨부파일 seq값 제거  -->
	<update id="setBoardAttachUpdt2" parameterClass="ApageBoardManageVo">
		<!-- 
		UPDATE COMTBOARD
		SET  ATCH_FILE_ID = null
		WHERE NTT_ID = #ntt_id#
		 -->
		UPDATE COMTBOARD
		SET  ATCH_FILE_ID = ''
		WHERE ATCH_FILE_ID = #atch_file_id#
	</update>
	
	<!-- 게시판 답글 리스트 -->
	<select id="selectBoardComment" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo">
		SELECT
			    Z.*
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
					SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
					FROM (
							SELECT SEQ, BBS_ID, PARENT_SEQ, CONTENT, REG_DT, REG_ID, UPDT_DT, UPDT_ID
							FROM tb_board_comment
							WHERE BBS_ID = #bbs_id#
							AND PARENT_SEQ = #ntt_id#
						 )X,(SELECT @ROWNUM := 0) R								 
						ORDER BY SEQ DESC
					  ) Y
		     ) Z
	</select>
	
	<!-- 게시판 답글 인서트 -->
	<insert id="insertBoardComment" parameterClass="ApageBoardManageVo">
		INSERT INTO tb_board_comment(
				bbs_id, parent_seq, content, reg_dt, reg_id
		)
		VALUES(
				#bbs_id#, #parent_seq#, #content#, NOW(), #reg_id#
		)	
	</insert>
	
	<!-- 게시판 답글 수정 -->
	<update id="updateBoardComment" parameterClass="ApageBoardManageVo" >
		UPDATE tb_board_comment SET
		content = #content#,
		updt_id = #updt_id#,
		updt_dt = now()
		WHERE seq = #seq#		
	</update>
	
	<!-- 게시판 답글 삭제 -->
	<delete id="deleteBoardComment" parameterClass="ApageBoardManageVo">
		DELETE FROM tb_board_comment
		WHERE seq = #seq#
	</delete>
	
	<!-- 게시판 답글 전체 삭제 -->
	<delete id="deleteComment" parameterClass="ApageBoardManageVo">
		DELETE FROM tb_board_comment
		WHERE parent_seq = #ntt_id#
	</delete>

		
	
	<!-- staff 리스트 -->
	<select id="selectadminStaffList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
				 	 <include refid="adminStaffBase"/>
				 	 WHERE 1 = 1
					ORDER BY seq DESC
				  ) Y
		     ) Z
		WHERE ASCNUM BETWEEN #currRow# AND #endRow#
	</select>
	
	<!-- staff 리스트 카운트 -->
	<select id="selectadminStaffListCnt" parameterClass="ApageBoardManageVo" resultClass="int" >
		SELECT
			    COUNT(*) CNT
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
 				<include refid="adminStaffBase"/>
 				WHERE 1 = 1
			) Y
		 ) Z
	</select>
	
	<!-- staff 인서트 -->
	<insert id="insertAdminStaff" parameterClass="ApageBoardManageVo" >
		 insert into staff_manage
         	(
				staff_name, asso_type, staff_type, team,
	            pro_no, career, use_hand, point_rank, hit,
	            staff_info, reg_dt, reg_id, atch_file_id,atch_file_id2	
             )
         VALUES
	         (
				#staff_name#, #asso_type#, #staff_type#, #team#,
	            #pro_no#, #career#, #use_hand#, #point_rank#, #hit#,
	            #staff_info#, NOW(), #reg_id#, #atch_file_id#, #atch_file_id2#
	         )
	    <selectKey keyProperty="seq" resultClass="int">
      	  	SELECT LAST_INSERT_ID()
   		</selectKey>
	</insert>
	
	<!-- staff 수정 -->
	<update id="updateAdminStaff" parameterClass="ApageBoardManageVo" >
		UPDATE staff_manage SET
		updt_id = #updt_id#
		,updt_dt = now()
		
		<isNotEmpty property="staff_name">
		,staff_name	= #staff_name#
		</isNotEmpty>
		
		<isNotEmpty property="asso_type">
		,asso_type	= #asso_type#
		</isNotEmpty>
		
		<isNotEmpty property="staff_type">
		,staff_type	= #staff_type#
		</isNotEmpty>
		
		<isNotEmpty property="team">
		,team	= #team#
		</isNotEmpty>
		
		<isNotEmpty property="pro_no">
		,pro_no	= #pro_no#
		</isNotEmpty>
		
		<isNotEmpty property="career">
		,career	= #career#
		</isNotEmpty>
		
		<isNotEmpty property="use_hand">
		,use_hand = #use_hand#
		</isNotEmpty>
		
		<isNotEmpty property="point_rank">
		,point_rank	= #point_rank#
		</isNotEmpty>
		
		<isNotEmpty property="staff_info">
		,staff_info	= #staff_info#
		</isNotEmpty>
		
		<isNotEmpty property="staff_name">
		,staff_name	= #staff_name#
		</isNotEmpty>
		
		<isNotEmpty property="atch_file_id">
		,atch_file_id =	#atch_file_id#
		</isNotEmpty>
		
		<isNotEmpty property="atch_file_id2">
		,atch_file_id2 =	#atch_file_id2#
		</isNotEmpty>
		
		WHERE seq = #seq#		
	</update>
	
	<!-- staff 삭제 -->
	<delete id="deleteAdminStaff" parameterClass="ApageBoardManageVo">
		DELETE FROM staff_manage
		WHERE seq = #seq#
	</delete>
	
	<!-- staff 상세 -->
	<select id="getAdminStaffView" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			 seq, staff_name, asso_type, staff_type, team,
             pro_no, career, use_hand, point_rank, hit,
             staff_info, reg_dt, reg_id, atch_file_id
		 FROM staff_manage
		WHERE seq = #seq#
	</select>
	
	<!-- 조회수 증가 -->
	<update id="UpdateStaffCnt" parameterClass="ApageBoardManageVo" >
		UPDATE	staff_manage SET
		hit = IFNULL(hit,0) + 1
		WHERE seq = #seq#
	</update>
	
	
	<!-- 대회신청 리스트 베이스 -->
	<sql id="adminContestBase">
	<!-- 
		SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
		FROM (
						SELECT cm.ct_seq, cm.ct_sbj, cm.ct_content, cm.ct_place, cm.ct_dt, cm.ct_process, cm.atch_file_id, cm.check_yn, cm.hit, cm.limit_part, 
							cm.reg_id, cm.updt_id, cm.reg_dt, cm.updt_dt, IFNULL(ca.pickCnt,0) AS pickCnt
						FROM (
											SELECT ct_seq, ct_sbj, ct_content, ct_place, ct_dt, ct_process, atch_file_id, check_yn, hit, limit_part,           
																reg_id, updt_id, DATE_FORMAT(reg_dt, '%Y-%m-%d') AS REG_DT,       DATE_FORMAT(updt_dt, '%Y-%m-%d') AS UPDT_DT        
											FROM contest_manage
						       ) AS cm
						LEFT OUTER JOIN 
										(SELECT ct_seq, COUNT(app_seq) AS pickCnt FROM contest_app WHERE STATUS = '0004'GROUP BY ct_seq) AS ca
						ON cm.ct_seq = ca.ct_seq
		)X,(SELECT @ROWNUM := 0) R			 
	 -->
		SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
		FROM (
				SELECT *
				FROM(
						SELECT
							CT_SEQ
							,CT_SBJ
							,CT_CONTENT
							,CT_PLACE
							,CT_DT
							,CT_PROCESS
							,ATCH_FILE_ID
							,LIMIT_PART
							,HIT
							,CHECK_YN
							,USE_AT
							,DATE_FORMAT(reg_dt, '%Y-%m-%d') AS REG_DT
							,REG_ID
							,DATE_FORMAT(updt_dt, '%Y-%m-%d') AS UPDT_DT 
							,UPDT_ID
							,DATE_FORMAT(app_start_dt, '%Y-%m-%d') AS APP_START_DT
							,APP_START_H
							,APP_START_M
							,DATE_FORMAT(app_end_dt, '%Y-%m-%d') AS APP_END_DT
							,APP_END_H
							,APP_END_M
							,PREPARE_YN
							,CT_GROUP
							,situation_show_yn
						FROM contest_manage
						) CM
		)X,(SELECT @ROWNUM := 0) R			 
	</sql>
	
	
	<!-- 대회신청 리스트 -->
	<select id="selectAdminContestList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			    ,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ) AS APP_CNT
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ AND STATUS = '0004' AND part = '1') AS part1_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ AND STATUS = '0004' AND part = '2') AS part2_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ AND STATUS = '0004' AND part = '3') AS part3_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ AND STATUS = '0004' AND part = '4') AS part4_app_cnt
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
				 	 <include refid="adminContestBase"/>
				 	 WHERE 1 = 1
					ORDER BY ct_seq DESC
				  ) Y
		     ) Z
		WHERE ASCNUM BETWEEN #currRow# AND #endRow#
	</select>
	
	<!-- 대회신청 리스트 no limit -->
	<select id="selectAdminContestListNoLimit" resultClass="ApageBoardManageVo" >
		SELECT
			 CT_SEQ
			,CT_SBJ
			,CT_CONTENT
			,CT_PLACE
			,CT_DT
			,CT_PROCESS
			,ATCH_FILE_ID
			,LIMIT_PART
			,HIT
			,CHECK_YN
			,USE_AT
			,DATE_FORMAT(reg_dt, '%Y-%m-%d') AS REG_DT
			,REG_ID
			,DATE_FORMAT(updt_dt, '%Y-%m-%d') AS UPDT_DT 
			,UPDT_ID
			,DATE_FORMAT(app_start_dt, '%Y-%m-%d') AS APP_START_DT
			,APP_START_H
			,APP_START_M
			,DATE_FORMAT(app_end_dt, '%Y-%m-%d') AS APP_END_DT
			,APP_END_H
			,APP_END_M
			,PREPARE_YN
			,CT_GROUP
			,situation_show_yn
		FROM contest_manage
		WHERE ct_process = 'F'
	</select>
	
	<!-- 대회신청 리스트 카운트 -->
	<select id="selectAdminContestListCnt" parameterClass="ApageBoardManageVo" resultClass="int" >
			SELECT  COUNT(*) CNT
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
 				<include refid="adminContestBase"/>
 				WHERE 1 = 1
			) Y
		 ) Z
	</select>
	
	
	<!-- 대회 인서트 -->
	<insert id="insertAdminContest" parameterClass="ApageBoardManageVo" >
		 insert into contest_manage
         	(
				 ct_sbj
				 , ct_content
				 , ct_place
				 , ct_dt
				 , check_yn
				 , ct_process
				 , limit_part
				 , limit_waiting 
				 , atch_file_id
				 , reg_id
				 , reg_dt
				 , app_start_dt
				 , app_start_h
				 , app_start_m
				 , app_end_dt
				 , app_end_h
				 , app_end_m
				 , prepare_yn
				 , ct_group,updt_yn
			
				,ct_bank
				,ct_acchholder
				,ct_account
				,ct_price
				,ct_deposit_stdt
				,ct_deposit_sth
				,ct_deposit_stm
				,ct_deposit_eddt
				,ct_deposit_edh
				,ct_deposit_edm
				,use_at
				
				,refund_finish_date
				,refund_finish_h
				,refund_finish_m
				,situation_show_yn
             )
         VALUES
	         (
				 #ct_sbj#
				 , #ct_content#
				 , #ct_place#
				 , #ct_dt#
				 , #check_yn#
				 , #ct_process#
				 , #limit_part#
				 , #limit_waiting# 
				 , #atch_file_id#
				 , #reg_id#
				 , now()
				 , #app_start_dt#
				 , #app_start_h#
				 , #app_start_m#
				 , #app_end_dt#
				 , #app_end_h#
				 , #app_end_m#
				 , #prepare_yn# 
				 , #ct_group#
				 , #updt_yn#
				 
			 	,#ct_bank#
				,#ct_acchholder#
				,#ct_account#
				,#ct_price#
				,#ct_deposit_stdt#
				,#ct_deposit_sth#
				,#ct_deposit_stm#
				,#ct_deposit_eddt#
				,#ct_deposit_edh#
				,#ct_deposit_edm#
				,#use_at#
				
				,#refund_finish_date#
				,#refund_finish_h#
				,#refund_finish_m#
				,#situation_show_yn#
	         )
	    <selectKey keyProperty="ct_seq" resultClass="int">
      	  	SELECT LAST_INSERT_ID()
   		</selectKey>
	</insert>
	
	<!-- 대회 수정 -->
	<update id="updateAdminContest" parameterClass="ApageBoardManageVo" >
		UPDATE contest_manage SET
		updt_id = #updt_id#
		,updt_dt = now()
		<isNotEmpty property="ct_sbj">
		,ct_sbj	= #ct_sbj#
		</isNotEmpty>
		<isNotEmpty property="ct_content">
		,ct_content	= #ct_content#
		</isNotEmpty>
		<isNotEmpty property="ct_place">
		,ct_place	= #ct_place#
		</isNotEmpty>
		<isNotEmpty property="ct_dt">
		,ct_dt	= #ct_dt#
		</isNotEmpty>
		<isNotEmpty property="ct_process">
		,ct_process	= #ct_process#
			<isEqual property="ct_process" compareValue="R" >
				<isNotEmpty property="ct_group">
					,ct_group = #ct_group#
				</isNotEmpty>
 	 		</isEqual>
		</isNotEmpty>
		<isNotEmpty property="limit_part">
		,limit_part	= #limit_part#
		</isNotEmpty>
		<isNotEmpty property="limit_waiting">
		,limit_waiting =	#limit_waiting#
		</isNotEmpty>	
		<isNotEmpty property="atch_file_id">
		,atch_file_id =	#atch_file_id#
		</isNotEmpty>	
		<isNotEmpty property="app_start_dt">
		,app_start_dt =	#app_start_dt#
		</isNotEmpty>	
		<isNotEmpty property="app_start_h">
		,app_start_h =	#app_start_h#
		</isNotEmpty>	
		<isNotEmpty property="app_start_m">
		,app_start_m =	#app_start_m#
		</isNotEmpty>	
		<isNotEmpty property="app_end_dt">
		,app_end_dt =	#app_end_dt#
		</isNotEmpty>	
		<isNotEmpty property="app_end_h">
		,app_end_h =	#app_end_h#
		</isNotEmpty>	
		<isNotEmpty property="app_end_m">
		,app_end_m =	#app_end_m#
		</isNotEmpty>	
		<isNotEmpty property="prepare_yn">
		,prepare_yn =	#prepare_yn#
		</isNotEmpty>	
		<isNotEmpty property="updt_yn">
		,updt_yn = #updt_yn#
		</isNotEmpty>


		<isNotEmpty property="ct_bank">
		,ct_bank = #ct_bank#
		</isNotEmpty>
		<isNotEmpty property="ct_acchholder">
		,ct_acchholder = #ct_acchholder#
		</isNotEmpty>
		<isNotEmpty property="ct_account">
		,ct_account = #ct_account#
		</isNotEmpty>
		<isNotEmpty property="ct_price">
		,ct_price = #ct_price#
		</isNotEmpty>
		<isNotEmpty property="ct_deposit_stdt">
		,ct_deposit_stdt = #ct_deposit_stdt#
		</isNotEmpty>
		<isNotEmpty property="ct_deposit_sth">
		,ct_deposit_sth = #ct_deposit_sth#
		</isNotEmpty>
		<isNotEmpty property="ct_deposit_stm">
		,ct_deposit_stm = #ct_deposit_stm#
		</isNotEmpty>
		<isNotEmpty property="ct_deposit_eddt">
		,ct_deposit_eddt = #ct_deposit_eddt#
		</isNotEmpty>
		<isNotEmpty property="ct_deposit_edh">
		,ct_deposit_edh = #ct_deposit_edh#
		</isNotEmpty>
		<isNotEmpty property="ct_deposit_edm">
		,ct_deposit_edm = #ct_deposit_edm#
		</isNotEmpty>
		<isNotEmpty property="use_at">
		,use_at = #use_at#
		</isNotEmpty>
				
		<isNotEmpty property="refund_finish_date">
		,refund_finish_date = #refund_finish_date#
		</isNotEmpty>
		<isNotEmpty property="refund_finish_h">
		,refund_finish_h = #refund_finish_h#
		</isNotEmpty>
		<isNotEmpty property="refund_finish_m">
		,refund_finish_m = #refund_finish_m#
		</isNotEmpty>
		<isNotEmpty property="situation_show_yn">
		,situation_show_yn = #situation_show_yn#
		</isNotEmpty>
		
		WHERE ct_seq = #ct_seq#		
	</update>
	
	<!-- 대회 삭제 -->
	<delete id="deleteAdminContest" parameterClass="ApageBoardManageVo">
		DELETE FROM contest_manage
		WHERE ct_seq = #ct_seq#
	</delete>
	
	<!-- 대회 상세 -->
	<select id="getAdminContestView" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT *
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ) AS APP_CNT
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ AND STATUS = '0004' AND part = '1') AS part1_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ AND STATUS = '0005' AND part = '1') AS part1_wait_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ AND STATUS = '0004' AND part = '2') AS part2_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ AND STATUS = '0005' AND part = '2') AS part2_wait_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ AND STATUS = '0004' AND part = '3') AS part3_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ AND STATUS = '0005' AND part = '3') AS part3_wait_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ AND STATUS = '0004' AND part = '4') AS part4_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = CM.CT_SEQ AND STATUS = '0005' AND part = '4') AS part4_wait_cnt
		FROM(
				SELECT
					 CT_SEQ
					,CT_SBJ
					,CT_CONTENT
					,CT_PLACE
					,CT_DT
					,CT_PROCESS
					,ATCH_FILE_ID
					,LIMIT_PART
					,HIT
					,CHECK_YN
					,USE_AT
					,ifnull(LIMIT_WAITING,0) as LIMIT_WAITING
					,DATE_FORMAT(reg_dt, '%Y-%m-%d') AS REG_DT
					,REG_ID
					,DATE_FORMAT(updt_dt, '%Y-%m-%d') AS UPDT_DT 
					,UPDT_ID	
					,DATE_FORMAT(app_start_dt, '%Y-%m-%d') AS APP_START_DT
					,APP_START_H
					,APP_START_M
					,DATE_FORMAT(app_end_dt, '%Y-%m-%d') AS APP_END_DT
					,APP_END_H
					,APP_END_M
					,PREPARE_YN
					,CT_GROUP
					,UPDT_YN
					,ct_bank
					,ct_acchholder
					,ct_account
					,ct_price
					,DATE_FORMAT(ct_deposit_stdt, '%Y-%m-%d') AS ct_deposit_stdt
					,ct_deposit_sth
					,ct_deposit_stm
					,DATE_FORMAT(ct_deposit_eddt, '%Y-%m-%d') AS ct_deposit_eddt
					,ct_deposit_edh
					,ct_deposit_edm
					,DATE_FORMAT(ct_sms_send_dt, '%Y%m') AS ct_sms_send_dt
					,DATE_FORMAT(ct_sms_send_dt, '%Y-%m-%d') AS ct_sms_send_dt2
					,EXPOSE_YN
					,CUT_YN
					,DATE_FORMAT(ct_lane_sms_send_dt, '%Y%m') AS ct_lane_sms_send_dt
					,DATE_FORMAT(ct_lane_sms_send_dt, '%Y-%m-%d') AS ct_lane_sms_send_dt2
					
					,DATE_FORMAT(refund_finish_date, '%Y-%m-%d') AS refund_finish_date
					,refund_finish_h
					,refund_finish_m
					,situation_show_yn
					,result_sms_send_yn
 					,lane_sms_send_yn
				FROM contest_manage
				WHERE CT_SEQ = #ct_seq#
		) CM
	</select>

	<!-- 첨부파일 초기화 -->
	<update id="updateAdminContestFile" parameterClass="ApageBoardManageVo" >
		UPDATE contest_manage SET
		atch_file_id =	NULL
		WHERE ct_seq = #ct_seq#		
	</update>	
	
	
	
	<!-- 대회신청자 리스트 베이스 -->
	<sql id="adminContestAppBase">
		SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
		FROM (
				SELECT
				  app_seq, ct_seq, join_name, deposit_name,
				  birth, gender, fn_decrypt(telno) as telno, fn_decrypt(email) as email, 
				  disable_yn, handicap, part, lane, status, agree_yn, reg_dt, reg_id
				  ,IFNULL(waiting_num,0) as waiting_num
				  ,SUBSTR(lane,1,(INSTR(lane, '-')-1)) AS lane_f ,SUBSTR(lane,(INSTR(lane, '-')+1)) AS lane_l
				  ,IFNULL(pay_flag,'N') as pay_flag	    
				  ,IFNULL(app_sms_flag,'N') as app_sms_flag	    
				  ,app_sms_date
				FROM contest_app
		)X,(SELECT @ROWNUM := 0) R			 
	</sql>
	
	<!-- 대회신청자(선정 및 입금완료 상태) 이름 가져오기 -->
	<select id="selectAllContestAppMemberName" parameterClass="ApageBoardManageVo" resultClass="string">
		SELECT 
			GROUP_CONCAT(join_name) AS join_name
		FROM contest_app
		WHERE ct_seq = #ct_seq# 
		AND STATUS = '0004' <!-- 선정 -->
		AND pay_flag = 'Y' <!-- 입금완료 -->
	</select>
	
	<!-- 대회신청자(선정 및 입금완료 상태) 아이디 가져오기 -->
	<select id="selectAllContestAppMemberID" parameterClass="ApageBoardManageVo" resultClass="string">
		SELECT 
			GROUP_CONCAT(reg_id) AS reg_id
		FROM contest_app
		WHERE ct_seq = #ct_seq# 
		AND STATUS = '0004' <!-- 선정 -->
		AND pay_flag = 'Y' <!-- 입금완료 -->
	</select>
	
	<!-- 대회신청자(선정 및 입금완료 상태) 전화번호 가져오기 -->
	<select id="selectAllContestAppMemberPhone" parameterClass="ApageBoardManageVo" resultClass="string">
		SELECT 
			GROUP_CONCAT(fn_decrypt(telno)) AS telno
		FROM contest_app
		WHERE ct_seq = #ct_seq# 
		AND STATUS = '0004' <!-- 선정 -->
		AND pay_flag = 'Y' <!-- 입금완료 -->
	</select>
	
	<!-- 대회신청 리스트 -->
	<select id="selectAdminContestAppList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
						SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
						FROM (
								SELECT
								  app_seq, ct_seq, join_name, deposit_name,
								  birth, gender, fn_decrypt(telno) as telno, fn_decrypt(email) as email, 
								  disable_yn, handicap, part, lane, status, agree_yn, reg_dt, reg_id
								  ,IFNULL(waiting_num,0) as waiting_num
								  ,SUBSTR(lane,1,(INSTR(lane, '-')-1)) AS lane_f ,SUBSTR(lane,(INSTR(lane, '-')+1)) AS lane_l
								  ,IFNULL(pay_flag,'N') as pay_flag	    
								  ,IFNULL(app_sms_flag,'N') as app_sms_flag	    
								  ,app_sms_date
								FROM contest_app
							 	WHERE 1 = 1
							 	AND ct_seq = #ct_seq#
								 	<isNotNull property="part">
								 		<isNotEmpty property="part">
								 	 	AND part = #part#			
									 	</isNotEmpty>
								 	</isNotNull>
								 	<isNull property="status">
								 	 	ORDER BY app_seq, reg_dt ASC
							 	 	</isNull>			
							 	 	<isNotNull property="status">
								 	 	<isNotEmpty property="status">
								 	 		AND STATUS = #status#
								 	 		<!-- 
								 	 		<isEqual property="status" compareValue="0004" >
												ORDER BY lane_f*1,lane_l*1
								 	 		</isEqual>
								 	 		<isEqual property="status" compareValue="0005" >
												ORDER BY waiting_num ASC
								 	 		</isEqual>
								 	 		 -->
								 			ORDER BY app_seq, reg_dt ASC
								 		</isNotEmpty>
							 	 	</isNotNull>	
						)X,(SELECT @ROWNUM := 0) R	
				  ) Y
		     ) Z
	</select>
	
	<!-- 대회신청 리스트 카운트 -->
	<select id="selectAdminContestAppListCnt" parameterClass="ApageBoardManageVo" resultClass="int" >
		SELECT  COUNT(*) CNT
		FROM (
			SELECT ROWNUM AS ASCNUM, Y.*
			FROM(
				<include refid="adminContestAppBase"/>
				WHERE 1 = 1
				AND ct_seq = #ct_seq#
				<isNotNull property="part">
			 	 	<isNotEmpty property="part">
			 	 	AND part = #part#			
				 	</isNotEmpty>
		 	 	</isNotNull>
			) Y
		 ) Z
	</select>
	
	<!-- 대회신청자 정보 수정 -->
	<update id="updateAdminContestApp" parameterClass="ApageBoardManageVo" >
		UPDATE contest_app SET
		updt_id = #updt_id#
		,updt_dt = now()	
		<isNotEmpty property="birth">
		,birth	= #birth#
		</isNotEmpty>	
		<isNotEmpty property="part">
		,part	= #part#
		</isNotEmpty>	
		<isNotEmpty property="telno">
		,telno	= fn_encrypt(#telno#)
		</isNotEmpty>
		<isNotEmpty property="gender">
		,gender	= #gender#
		</isNotEmpty>
		<isNotEmpty property="email">
		,email	= fn_encrypt(#email#)
		</isNotEmpty>
		<isNotEmpty property="disable_yn">
		,disable_yn	= #disable_yn#
		</isNotEmpty>
		<isNotEmpty property="handicap">
		,handicap	= #handicap#
		</isNotEmpty>
		<isNotEmpty property="lane">
		,lane	= #lane#
		</isNotEmpty>
		<isNotEmpty property="status">
			,status	= #status#
			<isNotEqual property="status" compareValue="0005" >
				,waiting_num = 0
 	 		</isNotEqual>
 	 		<isEqual property="status" compareValue="0003" >
 	 			<isNotEqual property="origin_status" compareValue="0003" >
					,ct_group = CONCAT(ct_group,'_',app_seq)
					,cancel_date = NOW()
 	 			</isNotEqual>
 	 		</isEqual>
		</isNotEmpty>
		<isNotEmpty property="pay_flag">
		,pay_flag	= #pay_flag#
		</isNotEmpty>
		WHERE app_seq = #app_seq#		
	</update>
	
	
	<!-- 대회신청자 삭제 -->
	<delete id="deleteAdminContestApp" parameterClass="ApageBoardManageVo">
		DELETE FROM contest_app
		WHERE app_seq = #app_seq#	
	</delete>
	
	<!-- 대회신청자 리스트 엑셀출력 -->
	<select id="selectAdminContestAppExcel" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
				 	 <include refid="adminContestAppBase"/>
				 	 WHERE 1 = 1
				 	 AND ct_seq = #ct_seq#		
					 ORDER BY part, app_seq
				  ) Y
		     ) Z
	</select>

	<!-- 대회신청자 랜덤 자리배치 -->
	<select id="createRandomLane" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT Z.* FROM (
					SELECT ROWNUM AS ASCNUM, Y.*
					FROM(
					
					SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
					FROM (
							SELECT 
								lane, app_seq, ct_seq, join_name, deposit_name,
								birth, case when gender = 'M' then '남' else '여' end as gender, 
								fn_decrypt(telno) AS telno, fn_decrypt(email) AS email, 
								disable_yn, handicap, part, STATUS
							FROM contest_app
							WHERE ct_seq = #ct_seq#
							AND part = #part#
							AND STATUS = '0004'
							<!-- AND PAY_FLAG = 'Y' -->
							ORDER BY part,RAND()
					)X,(SELECT @ROWNUM := 0) R							 	
				) Y
		) Z
	</select>
	
	
	<!-- 대회 신청마감 리스트 -->
	<select id="selectAdminContestAppFinishList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			    ,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ) AS APP_CNT
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ AND STATUS = '0004' AND part = '1') AS part1_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ AND STATUS = '0004' AND part = '2') AS part2_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ AND STATUS = '0004' AND part = '3') AS part3_app_cnt
				,(SELECT COUNT(*) FROM contest_app WHERE ct_seq = Z.CT_SEQ AND STATUS = '0004' AND part = '4') AS part4_app_cnt
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
				 	 SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
					FROM (
							SELECT *
							FROM(
									SELECT
										CT_SEQ
										,CT_SBJ
										,CT_CONTENT
										,CT_PLACE
										,CT_DT
										,CT_PROCESS
										,ATCH_FILE_ID
										,LIMIT_PART
										,HIT
										,CHECK_YN
										,USE_AT
										,DATE_FORMAT(reg_dt, '%Y-%m-%d') AS REG_DT
										,REG_ID
										,DATE_FORMAT(updt_dt, '%Y-%m-%d') AS UPDT_DT 
										,UPDT_ID	
									FROM contest_manage
									WHERE (ct_process = 'E' OR ct_process = 'F')
									) CM
					)X,(SELECT @ROWNUM := 0) R			 
				 	 WHERE 1 = 1
					ORDER BY ct_seq DESC
				  ) Y
		     ) Z
		WHERE ASCNUM BETWEEN #currRow# AND #endRow#
	</select>
	
	<!-- 대회 신청마감 리스트카운트 -->
	<select id="selectAdminContestAppFinishListCnt" parameterClass="ApageBoardManageVo" resultClass="int" >
		SELECT COUNT(*) CNT
		FROM contest_manage
		WHERE (ct_process = 'E' OR ct_process = 'F')
	</select>
	
	<!-- 선정결과 사용자 페이지 노출여부 update -->
	<update id="updateContestAppResultExposeYn" parameterClass="ApageBoardManageVo">
		UPDATE contest_manage 
		SET expose_yn = #expose_yn#		
		WHERE ct_seq = #ct_seq#
	</update>
	
	<!-- 대회 선정자 리스트 엑셀 -->
	<select id="selectAdminContestSelectResultExcel" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			app_seq, ct_seq, join_name, deposit_name,
			birth, gender, fn_decrypt(telno) as telno, fn_decrypt(email) as email, 
			disable_yn, handicap, part, lane, status, agree_yn, reg_dt, reg_id
			,SUBSTR(lane,1,(INSTR(lane, '-')-1)) AS lane_f
			,SUBSTR(lane,(INSTR(lane, '-')+1)) AS lane_l	  
		FROM contest_app
		WHERE ct_seq = #ct_seq#
		AND part = #part#
		AND status = '0004'
		ORDER BY lane_f*1,lane_l*1		
	</select>
	
	<!-- //대회 선정자 레인 랜덤배정 업데이트 -->
	<update id="updateAppRandomLane" parameterClass="ApageBoardManageVo">
	  UPDATE contest_app SET 
	  		lane = #lane#
	  		,updt_dt = now()
	  		,updt_id = #updt_id#
	  WHERE APP_SEQ = #app_seq#
	</update>
	
	<!-- //대회 선정자 취소시 대기인원 선정 업데이트 -->
	<update id="updateWaitingToSelect" parameterClass="ApageBoardManageVo">
		UPDATE contest_app a
			,(
				SELECT app_seq
				FROM contest_app 
				WHERE ct_seq = #ct_seq#
				AND STATUS='0005' 
				AND waiting_num != 0 
				<!-- 
				AND pay_flag = 'Y'
				 -->
				AND part= #part#
				ORDER BY waiting_num ASC
				LIMIT 1	
			  ) b
		SET a.status = '0004', updt_dt = NOW(), updt_id = #updt_id# , lane = #lane# , waiting_num = 0
		WHERE a.app_seq = b.app_seq
	</update>
	
	<!-- //대회 예정,진행 리스트 -->
	<select id="apageSelectExpectContestList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo">
		SELECT 
			ct_seq
			,ct_sbj
			,ct_process
			,ct_dt
		FROM contest_manage
		WHERE (ct_process = 'R' OR ct_process = 'S')
	</select>
	
	<!-- 대회상세 그룹 리스트 -->
	<select id="apageSelectExpectContestGroupList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo">
		SELECT 
			ct_seq
			,ct_sbj
			,ct_process
			,ct_dt
		FROM contest_manage
		WHERE CT_SEQ IN 
			<iterate open="(" close=")" property="ct_seq_arr" conjunction=",">
			 	#ct_seq_arr[]#
			</iterate>   
	</select>
	
	<!-- //자동배치결과 삭제 -->
	<delete id="deleteAdminBoardLaneResult" parameterClass="ApageBoardManageVo">
		DELETE FROM COMTBOARD 
		WHERE CT_SEQ = #ct_seq#
		AND BBS_ID = 'laneResult'
	</delete>
	
	
	<!-- //대회 신청 결과(선정,대기) -->
	<select id="selectAdminContestAppResultList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
			 	 	SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
					FROM (
							SELECT
							  app_seq, ct_seq, join_name, deposit_name,
							  birth, gender, fn_decrypt(telno) as telno, fn_decrypt(email) as email, 
							  disable_yn, handicap, part, lane, status, agree_yn, reg_dt, reg_id
							  ,IFNULL(waiting_num,0) as waiting_num
							  ,SUBSTR(lane,1,(INSTR(lane, '-')-1)) AS lane_f ,SUBSTR(lane,(INSTR(lane, '-')+1)) AS lane_l
							  ,IFNULL(pay_flag,'N') as pay_flag	    
							  ,IFNULL(app_sms_flag,'N') as app_sms_flag	    
							  ,app_sms_date
							  ,IFNULL(app_lane_sms_flag,'N') as app_lane_sms_flag	    
							  ,app_lane_sms_date
							FROM contest_app
							 WHERE ct_seq = #ct_seq#
						 	 AND (status = '0005' OR status = '0004')
						 	 AND app_sms_flag = 'N'
					)X,(SELECT @ROWNUM := 0) R	
				 	 WHERE 1 = 1
				  ) Y
		     ) Z
	</select>
	
	<!-- //대회 레인 랜덤배정 결과(선정,대기) -->
	<select id="selectAdminContestRandomLaneResultList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
			 	 	SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
					FROM (
							SELECT
							  app_seq, ct_seq, join_name, deposit_name,
							  birth, gender, fn_decrypt(telno) as telno, fn_decrypt(email) as email, 
							  disable_yn, handicap, part, lane, status, agree_yn, reg_dt, reg_id
							  ,IFNULL(waiting_num,0) as waiting_num
							  ,SUBSTR(lane,1,(INSTR(lane, '-')-1)) AS lane_f ,SUBSTR(lane,(INSTR(lane, '-')+1)) AS lane_l
							  ,IFNULL(pay_flag,'N') as pay_flag	    
							  ,IFNULL(app_sms_flag,'N') as app_sms_flag	    
							  ,app_sms_date
							  ,IFNULL(app_lane_sms_flag,'N') as app_lane_sms_flag	    
							  ,app_lane_sms_date
							FROM contest_app
							 WHERE ct_seq = #ct_seq#
						 	 AND status = '0004'
						 	 AND app_lane_sms_flag = 'N'
					)X,(SELECT @ROWNUM := 0) R	
				 	 WHERE 1 = 1
				  ) Y
		     ) Z
	</select>
	
	<!-- //대회 문자발송일 업데이트 -->
	<update id="apageUpdateContestMsgSendDate" parameterClass="ApageBoardManageVo">
		UPDATE contest_manage SET 
			 ct_sms_send_dt = now()
			,result_sms_send_yn = 'Y'
		WHERE ct_seq = #ct_seq#
	</update>
	
	<!-- //대회 레인 랜덤배정 문자발송일 업데이트 -->
	<update id="apageUpdateContestRandomLaneMsgSendDate" parameterClass="ApageBoardManageVo">
		UPDATE contest_manage SET 
			 ct_lane_sms_send_dt = now() 
			,lane_sms_send_yn = 'Y'
		WHERE ct_seq = #ct_seq#
	</update>
	
	<!-- //대회 문자발송 결과 업데이트 -->
	<update id="apageUpdateAppSmsFlag" parameterClass="ApageBoardManageVo">
		UPDATE contest_app
		SET app_sms_flag = 'Y'
		WHERE app_seq IN
		<iterate open="(" close=")" property="app_seq_arr" conjunction=",">
		 	#app_seq_arr[]#
		</iterate>
	</update>
	
	<!-- //대회 문자발송 결과 업데이트 -->
	<update id="apageUpdateAppRandomLaneSmsFlag" parameterClass="ApageBoardManageVo">
		UPDATE contest_app
		SET app_lane_sms_flag = 'Y'
		WHERE app_seq IN
		<iterate open="(" close=")" property="app_seq_arr" conjunction=",">
		 	#app_seq_arr[]#
		</iterate>
	</update>
	
	<!-- //대회신청 문자발송여부 N 처리, 발송시간 UPDATE -->
	<update id="apageUpdateContestAppSendFlagAndDate" parameterClass="ApageBoardManageVo">
		UPDATE contest_app SET 
			 app_sms_flag = 'N'
			,app_sms_date = now()
		WHERE ct_seq = #ct_seq#
	</update>
	
	<!-- //대회 레인 랜덤배정 문자발송여부 N 처리, 발송시간 UPDATE -->
	<update id="apageUpdateContestRandomLaneSendFlagAndDate" parameterClass="ApageBoardManageVo">
		UPDATE contest_app SET 
			 app_lane_sms_flag = 'N'
			,app_lane_sms_date = now()
		WHERE ct_seq = #ct_seq#
	</update>
	
	<!-- //대기자 이동시 대기번호 UPDATE -->
	<update id="apageUpdateContestAppWaitingNum" parameterClass="ApageBoardManageVo">
		UPDATE contest_app ca,
			(SELECT (MAX(waiting_num)+1) as waiting_num FROM contest_app WHERE ct_seq = #ct_seq# AND part = #part#) ca2
		SET 
			 ca.waiting_num = ca2.waiting_num
			 ,ca.lane = '' 
		WHERE ca.app_seq = #app_seq#
	</update>
	
		
	<!-- //대회신청결과 PART별 조회 -->
	<select id="selectAdminContestAppResultGubunPartList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT
			    Z.*
			FROM (
				SELECT ROWNUM AS ASCNUM, Y.*
				FROM(
				 	 <include refid="adminContestAppBase"/>
				 	 WHERE 1 = 1
				 	 AND ct_seq = #ct_seq#
				 	 AND part = #part#
				 	 <!-- AND (status = '0005' OR status = '0004') -->
				 	 AND status = '0004'
				  ) Y
		     ) Z
	</select>	
		
	<!-- //조별 문자메세지 전송이력 -->
	<select id="selectAdminContestAppLaneSmsSendResultList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
			SELECT
					  app_seq, ct_seq, join_name, deposit_name,
					  birth, gender, fn_decrypt(telno) as telno, fn_decrypt(email) as email, 
					  disable_yn, handicap, part, lane, status, agree_yn, reg_dt, reg_id
					  ,IFNULL(waiting_num,0) as waiting_num
					  ,SUBSTR(lane,1,(INSTR(lane, '-')-1)) AS lane_f ,SUBSTR(lane,(INSTR(lane, '-')+1)) AS lane_l
					  ,IFNULL(pay_flag,'N') as pay_flag	    
					  ,IFNULL(app_sms_flag,'N') as app_sms_flag	    
					  ,app_sms_date
					  ,app_lane_sms_flag
					  ,app_lane_sms_date
			FROM contest_app
			WHERE 1 = 1
			AND ct_seq = #ct_seq#
			AND part = #part#
			AND status = '0004'
			ORDER BY lane_f*1,lane_l*1
	</select>	
	
	
	<!-- 신청마감 후 랭키나열 후 상태 UPDATE -->
	<update id="apageContestAppResultOrderStatusChange" parameterClass="ApageBoardManageVo">
	<![CDATA[
			UPDATE contest_app capp,(
			SELECT 
				 rownum
				,app_seq
				,ct_seq
				,part
				,STATUS
				,reg_id
				,join_name
				,reg_dt
				,limit_part
				,limit_waiting
				,total_limit
				,CASE 
					WHEN rownum <= limit_part THEN '0004'
					ELSE '0005'
				END AS result_status
				,CASE 
					WHEN (rownum-limit_part) > 0 THEN (rownum-limit_part)
					ELSE 0 
				END AS waiting_num
				
			FROM (
				SELECT  @ROWNUM := @ROWNUM + 1 AS ROWNUM, X.* 
				FROM (
					SELECT 
						 ca.app_seq
						,ca.ct_seq
						,ca.status
						,ca.reg_dt
						,ca.join_name
						,ca.reg_id
						,part
						,ca.waiting_num
						,cm.limit_part
						,cm.limit_waiting
						,(cm.limit_part+cm.limit_waiting) AS total_limit
					FROM contest_app ca
					JOIN contest_manage cm
					WHERE ca.ct_seq = cm.ct_seq
					AND ca.status != '0003'
					AND ca.ct_seq = #ct_seq#
					AND ca.part = #part#
					ORDER BY ca.app_seq ASC, ca.REG_DT ASC
				)X,(SELECT @ROWNUM := 0) R
			) Q
		) uapp 
		SET capp.status = uapp.result_status
			,capp.waiting_num = uapp.waiting_num
			,capp.updt_dt = now()
			,capp.updt_id = #updt_id#
		WHERE capp.app_seq = uapp.app_seq
		AND capp.reg_id = uapp.reg_id
		AND capp.ct_seq = uapp.ct_seq
		]]>
	</update>
	
	<!-- 업데이트 완료 후 대회 ROWNUM 정렬 플래그 cut_yn ==> Y로 변경 -->
	<update id="apageContestCutYnUpdate" parameterClass="ApageBoardManageVo">
		UPDATE contest_manage SET
			CUT_YN = #cut_yn#
		WHERE ct_seq = #ct_seq#
	</update>
	
	<!-- 레인배치 결과노출 -->
	<update id="contestAppResultExposeYn" parameterClass="ApageBoardManageVo">
		UPDATE contest_manage SET
			CT_RESULT = #ct_result#
		WHERE ct_seq = #ct_seq#
	</update>
	
	<!-- //각 대회 환불 리스트  -->
	<select id="apageContestRefundList" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
			SELECT
					 app_seq
					,ct_seq
					,join_name
					,deposit_name
					,gender
					,fn_decrypt(telno) as telno
					,fn_decrypt(email) as email
					,disable_yn
					,handicap
					,part
					,lane
					,STATUS
					,reg_dt
					,IFNULL(pay_flag , 'N') AS pay_flag
					,refund_bank
					,refund_accholder
					,refund_account
					,updt_id
					,reg_id
					,cancel_date
			FROM contest_app
			WHERE 1 = 1
			AND STATUS = '0003'
			<!-- AND pay_flag = 'Y' -->
			AND ct_seq = #ct_seq#
			AND part = #part#
			ORDER BY app_seq asc
	</select>	
	
		
	<!-- //최우선 대기자 추출 -->	
	<select id="apageGetCtPartWaitingInfo"  parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo" >
		SELECT 
			app_seq, ct_seq, join_name, deposit_name,
			birth, gender, fn_decrypt(telno) as telno, fn_decrypt(email) as email, 
			disable_yn, handicap, part, lane, status, agree_yn, reg_dt, reg_id
			,IFNULL(waiting_num,0) AS waiting_num	  
		FROM contest_app 
		WHERE ct_seq = #ct_seq#
		AND STATUS = '0005' 
		AND waiting_num != 0 
		AND part= #part#
		ORDER BY waiting_num ASC
		LIMIT 1	
	</select>
	
	<!-- 대회 수정 -->
	<update id="apageAppSituationShowUpdate" parameterClass="ApageBoardManageVo" >
		UPDATE contest_manage SET
		updt_id = #updt_id#
		,updt_dt = now()
		,situation_show_yn = #situation_show_yn#
		WHERE ct_seq = #ct_seq#		
	</update>
	
	<!-- 회원관리 > 대회신청이력 -->
	<select id="apageGetContestInfoOfEachMember" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo">
		SELECT 
			 cm.ct_seq
			,cm.ct_sbj
			,cm.ct_place
			,cm.ct_dt
			,cm.ct_process
			,ca.app_seq
			,ca.reg_id
			<!-- 
			,ca.app_seq
			,ca.ct_seq
			,ca.join_name
			,ca.deposit_name
			,ca.birth
			,ca.gender
			,fn_decrypt(ca.telno) as telno
			,fn_decrypt(ca.email) as email
			,ca.disable_yn
			,ca.handicap
			,ca.part
			,ca.lane
			,ca.status
			,ca.waiting_num
			,ca.reg_id
			,DATE_FORMAT(ca.reg_dt, '%Y-%m-%d') reg_dt
			,(select updt_yn from contest_manage where ct_seq = ca.ct_seq) as updt_yn
			,ca.pay_flag
			,ca.refund_bank
			,ca.refund_accholder
			,ca.refund_account
			 -->
		FROM contest_manage cm
		JOIN contest_app ca
		WHERE cm.ct_seq = ca.ct_seq
		AND ca.reg_id = #reg_id#
		ORDER BY cm.ct_dt DESC
	</select>
	
	<!-- 회원관리 > 대회신청이력 상세 -->
	<select id="apageGetContestInfoDetailOfEachMember" parameterClass="ApageBoardManageVo" resultClass="ApageBoardManageVo">
		SELECT
			 app_seq
			,ct_seq
			,join_name
			,deposit_name
			,birth
			,gender
			,telno AS telno_string <!-- telno가 암호화되지 않고 들어간 데이터들이 있음. -->
			,fn_decrypt(telno) as telno
			,fn_decrypt(email) as email
			,disable_yn
			,handicap
			,part
			,lane
			,status
			,waiting_num
			,reg_id
			,reg_dt
			<!-- ,DATE_FORMAT(reg_dt, '%Y-%m-%d') reg_dt -->
			<!-- ,(select updt_yn from contest_manage where ct_seq = ct_seq) as updt_yn -->
			,pay_flag
			,refund_bank
			,refund_accholder
			,refund_account
			,DATE_FORMAT(cancel_date, '%Y-%m-%d') cancel_date
		FROM contest_app
		WHERE app_seq = #app_seq#
		<!-- 
		ct_seq = #ct_seq# 
		AND reg_id = #reg_id#
		 -->
	</select>
	
	
	
	<!-- 쇼핑몰 이벤트대회 접수일자 정보 변경 --> 
	<update id="apageUpdateShopEventManageInfo" parameterClass="ApageBoardManageVo" >
		UPDATE shop_event_manage SET 
		   shop_event_process = #shop_event_process#
		  ,shop_event_start_dt = #shop_event_start_dt#
		  ,shop_event_start_h = #shop_event_start_h#
		  ,shop_event_start_m = #shop_event_start_m#
		  ,shop_event_end_dt = #shop_event_end_dt#
		  ,shop_event_end_h = #shop_event_end_h#
		  ,shop_event_end_m = #shop_event_end_m#
	</update>
	
	
	
	
</sqlMap>